<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ëŒ€ì „ì¥ëŒ€ì¤‘í•™êµ ì—…ë¬´ ì•ˆë‚´</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body{background:linear-gradient(135deg,#f0fdf4 0%,#dcfce7 50%,#bbf7d0 100%);font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    .glass-effect{background:rgba(255,255,255,.85);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.9);box-shadow:0 8px 32px rgba(0,0,0,.1)}
    .modal-glass{background:rgba(255,255,255,.95);backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,.8)}
    .calendar-day{min-height:80px;transition:all .3s ease}
    .calendar-day:hover{background:rgba(255,255,255,.3)}
    .week-day{min-height:120px}
    .memo-item{transition:transform .2s ease}
    .memo-item:hover{transform:translateY(-2px)}
  </style>

  <script>
    // --- Supabase ì´ˆê¸°í™” (ë„¤ ê°’ ë°˜ì˜ë¨) ---
    const SUPABASE_URL = "https://crwpivblcgvnhmtphlhm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNyd3BpdmJsY2d2bmhtdHBobGhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxODIxNjQsImV4cCI6MjA3NDc1ODE2NH0.7O8-w4NFKBlo0h9uESWt5sCGd-XWoRnsf_Pu3cpkcZc";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true },
    });

    // --- ìœ í‹¸: 4ìë¦¬ ë¹„ë²ˆ í•´ì‹œ ì €ì¥ìš© (ë©”ëª¨ ì‚­ì œ í™•ì¸) ---
    async function sha256(text) {
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
  </script>
</head>

<body class="min-h-screen p-4">
  <div class="max-w-7xl mx-auto">
    <!-- í—¤ë” -->
    <div class="glass-effect rounded-2xl p-6 mb-6 shadow-lg">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-4">
          <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center shadow-lg">
            <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6l2-1.09V17h2V9L12 3zm6.82 6L12 12.72 5.18 9 12 5.28 18.82 9zM17 15.99l-5 2.73-5-2.73v-3.72L12 15l5-2.73v3.72z"/>
            </svg>
          </div>
          <h1 class="text-3xl font-bold text-green-800">ëŒ€ì „ì¥ëŒ€ì¤‘í•™êµ ì›”ê°„/ì£¼ê°„ ì—…ë¬´ ê³„íš</h1>
        </div>
        <div class="flex gap-2">
          <button id="monthViewBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">ì›”ê°„ ë³´ê¸°</button>
          <button id="weekViewBtn" class="px-6 py-2 bg-white text-green-600 rounded-lg hover:bg-green-50 transition-colors font-medium border border-green-600">ì£¼ê°„ ë³´ê¸°</button>
        </div>
      </div>
    </div>

    <!-- ì œì¶œì„ë°• & í€µë©”ëª¨ì¡´ -->
    <div class="grid md:grid-cols-2 gap-6 mb-6">
      <div class="glass-effect rounded-2xl p-6 shadow-lg">
        <h2 class="text-xl font-bold text-green-800 mb-4 flex items-center">
          <span class="mr-2">âš ï¸</span>ì œì¶œì„ë°•
        </h2>
        <div id="urgentTasks" class="space-y-3"></div>
      </div>

      <div class="glass-effect rounded-2xl p-6 shadow-lg">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-green-800 flex items-center">
            <span class="mr-2">ğŸ“</span>í€µ ë©”ëª¨ì¡´
          </h2>
          <button id="addMemoBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">ë©”ëª¨ ì¶”ê°€</button>
        </div>
        <div id="memoList" class="space-y-2 max-h-40 overflow-y-auto"></div>
      </div>
    </div>

    <!-- ì›”ë³„/ì£¼ë³„ ì¼ì • -->
    <div class="glass-effect rounded-2xl p-6 mb-6 shadow-lg">
      <div id="calendarHeader" class="flex justify-between items-center mb-6">
        <button id="prevBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">â—€ ì´ì „</button>
        <h2 id="calendarTitle" class="text-2xl font-bold text-green-800">2025ë…„ 1ì›”</h2>
        <button id="nextBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">ë‹¤ìŒ â–¶</button>
      </div>

      <!-- ì›”ê°„ -->
      <div id="monthView" class="calendar-view">
        <div class="grid grid-cols-7 gap-1 mb-2">
          <div class="text-center font-bold text-red-600 p-2">ì¼</div>
          <div class="text-center font-bold text-green-800 p-2">ì›”</div>
          <div class="text-center font-bold text-green-800 p-2">í™”</div>
          <div class="text-center font-bold text-green-800 p-2">ìˆ˜</div>
          <div class="text-center font-bold text-green-800 p-2">ëª©</div>
          <div class="text-center font-bold text-green-800 p-2">ê¸ˆ</div>
          <div class="text-center font-bold text-blue-600 p-2">í† </div>
        </div>
        <div id="monthCalendar" class="grid grid-cols-7 gap-1"></div>
      </div>

      <!-- ì£¼ê°„ -->
      <div id="weekView" class="calendar-view hidden">
        <div class="grid grid-cols-7 gap-2">
          <div class="text-center font-bold text-red-600 p-2">ì¼</div>
          <div class="text-center font-bold text-green-800 p-2">ì›”</div>
          <div class="text-center font-bold text-green-800 p-2">í™”</div>
          <div class="text-center font-bold text-green-800 p-2">ìˆ˜</div>
          <div class="text-center font-bold text-green-800 p-2">ëª©</div>
          <div class="text-center font-bold text-green-800 p-2">ê¸ˆ</div>
          <div class="text-center font-bold text-blue-600 p-2">í† </div>
        </div>
        <div id="weekCalendar" class="grid grid-cols-7 gap-2 mt-2"></div>
      </div>

      <button id="addEventBtn" class="mt-6 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium w-full">ì¼ì • ì¶”ê°€</button>
    </div>

    <!-- ìë£Œ ì§‘ê³„ -->
    <div class="glass-effect rounded-2xl p-6 shadow-lg">
      <h2 class="text-xl font-bold text-green-800 mb-4 flex items-center">
        <span class="mr-2">ğŸ“Š</span>ìë£Œ ì§‘ê³„
      </h2>
      <div id="uploadArea" class="border-2 border-dashed border-green-400 rounded-lg text-center mb-4">
        <input type="file" id="imageUpload" accept="image/*" class="hidden">
        <div id="uploadButton" class="p-8">
          <button onclick="document.getElementById('imageUpload').click()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">ğŸ“· ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
          <p class="text-green-700 mt-2">í™”ë©´ ìº¡ì³ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
        </div>
        <div id="uploadedImages" class="p-4 hidden w-full"></div>
        <div class="text-right text-green-700 text-sm mt-4 px-4 pb-4">
          ìµœì¢… ìˆ˜ì •: <span id="lastModified">-</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ì¼ì • ì¶”ê°€ ëª¨ë‹¬ -->
  <div id="eventModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="modal-glass rounded-2xl p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto shadow-2xl">
      <h3 class="text-xl font-bold text-green-800 mb-4">ì¼ì • ì¶”ê°€</h3>
      <form id="eventForm">
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">ë¶€ì„œ</label>
          <select id="eventDepartment" class="w-full p-3 border border-green-300 rounded-lg" required>
            <option value="">ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
            <option>êµë¬´ìš´ì˜ë¶€</option><option>êµìœ¡ì—°êµ¬ë¶€</option><option>ìƒí™œì•ˆì „ë¶€</option>
            <option>êµìœ¡ì •ë³´íƒêµ¬ë¶€</option><option>ì²´ìœ¡ë³´ê±´ë¶€</option><option>ì§„ë¡œì§„í•™ìƒë‹´ë¶€</option>
            <option>ì§€ì—­ì‚¬íšŒí™˜ê²½ë¶€</option><option>í•™ë ¥ì‹ ì¥ë°©ê³¼í›„í•™êµë¶€</option>
            <option>1í•™ë…„ë¶€</option><option>2í•™ë…„ë¶€</option><option>3í•™ë…„ë¶€</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">ì œëª©</label>
          <input type="text" id="eventTitle" class="w-full p-3 border border-green-300 rounded-lg" required>
        </div>
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">ì„¤ëª…</label>
          <textarea id="eventDescription" class="w-full p-3 border border-green-300 rounded-lg h-20"></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">ì‹œê°„</label>
          <input type="time" id="eventTime" class="w-full p-3 border border-green-300 rounded-lg">
        </div>
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">ì¥ì†Œ</label>
          <input type="text" id="eventLocation" class="w-full p-3 border border-green-300 rounded-lg">
        </div>
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">ìœ í˜•</label>
          <select id="eventType" class="w-full p-3 border border-green-300 rounded-lg">
            <option>íšŒì˜</option><option>ì œì¶œ</option><option>í•™ì‚¬ì¼ì •</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="flex items-center">
            <input type="checkbox" id="urgentAlert" class="mr-2">
            <span class="text-green-800">ì œì¶œ ì„ë°• ì•ŒëŒ í‘œì‹œ</span>
          </label>
        </div>
        <div class="flex gap-3">
          <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">ì¶”ê°€</button>
          <button type="button" id="cancelEventBtn" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">ì·¨ì†Œ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ë©”ëª¨ ì¶”ê°€ ëª¨ë‹¬ -->
  <div id="memoModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="modal-glass rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl">
      <h3 class="text-xl font-bold text-green-800 mb-4">ë©”ëª¨ ì¶”ê°€</h3>
      <form id="memoForm">
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">ë¶€ì„œ</label>
          <select id="memoDepartment" class="w-full p-3 border border-green-300 rounded-lg" required>
            <option value="">ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
            <option>êµë¬´ìš´ì˜ë¶€</option><option>êµìœ¡ì—°êµ¬ë¶€</option><option>ìƒí™œì•ˆì „ë¶€</option>
            <option>êµìœ¡ì •ë³´íƒêµ¬ë¶€</option><option>ì²´ìœ¡ë³´ê±´ë¶€</option><option>ì§„ë¡œì§„í•™ìƒë‹´ë¶€</option>
            <option>ì§€ì—­ì‚¬íšŒí™˜ê²½ë¶€</option><option>í•™ë ¥ì‹ ì¥ë°©ê³¼í›„í•™êµë¶€</option>
            <option>1í•™ë…„ë¶€</option><option>2í•™ë…„ë¶€</option><option>3í•™ë…„ë¶€</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">ë©”ëª¨ ë‚´ìš©</label>
          <textarea id="memoContent" class="w-full p-3 border border-green-300 rounded-lg h-24" required></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬ ìˆ«ì)</label>
          <input type="password" id="memoPassword" class="w-full p-3 border border-green-300 rounded-lg" pattern="[0-9]{4}" maxlength="4" required>
        </div>
        <div class="flex gap-3">
          <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">ì¶”ê°€</button>
          <button type="button" id="cancelMemoBtn" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">ì·¨ì†Œ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ë©”ëª¨ ìƒì„¸ ëª¨ë‹¬ -->
  <div id="memoDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="modal-glass rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl">
      <h3 class="text-xl font-bold text-green-800 mb-4">ë©”ëª¨ ìƒì„¸</h3>
      <div id="memoDetailContent" class="mb-4 p-3 bg-white bg-opacity-50 rounded-lg min-h-[100px]"></div>
      <div class="flex gap-3">
        <button id="deleteMemoBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">ì‚­ì œ</button>
        <button id="closeMemoDetailBtn" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì¼ì • ìƒì„¸ ëª¨ë‹¬ -->
  <div id="eventDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="modal-glass rounded-2xl p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto shadow-2xl">
      <h3 class="text-xl font-bold text-green-800 mb-4">ì¼ì • ìƒì„¸</h3>
      <div id="eventDetailContent" class="mb-4 space-y-3"></div>
      <div class="flex gap-3">
        <button id="editEventBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">í¸ì§‘</button>
        <button id="deleteEventBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">ì‚­ì œ</button>
        <button id="closeEventDetailBtn" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ëª¨ë‹¬ -->
  <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="modal-glass rounded-2xl p-6 max-w-sm w-full mx-4 shadow-2xl">
      <h3 class="text-xl font-bold text-green-800 mb-4">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</h3>
      <form id="passwordForm">
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</label>
          <input type="password" id="deletePassword" class="w-full p-3 border border-green-300 rounded-lg" pattern="[0-9]{4}" maxlength="4" required>
        </div>
        <div class="flex gap-3">
          <button type="submit" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">ì‚­ì œ</button>
          <button type="button" id="cancelPasswordBtn" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">ì·¨ì†Œ</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ====== ìƒíƒœ ======
    let currentDate = new Date();
    let currentView = 'month';
    let selectedDate = null;
    let events = {};            // {dateKey: [{...}]}
    let memos = [];
    let currentMemoIndex = null;
    let currentEventId = null;
    let isEditingEvent = false;

    // 2025 ê³µíœ´ì¼ (ê·¸ëŒ€ë¡œ ìœ ì§€)
    const holidays = {'2025':{'0-1':'ì‹ ì •','0-27':'ì„¤ë‚  ì—°íœ´','0-28':'ì„¤ë‚ ','0-29':'ì„¤ë‚  ì—°íœ´','2-1':'ì‚¼ì¼ì ˆ','2-3':'ì‚¼ì¼ì ˆ ëŒ€ì²´ê³µíœ´ì¼','4-5':'ì–´ë¦°ì´ë‚ ','4-6':'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ','5-6':'í˜„ì¶©ì¼','7-15':'ê´‘ë³µì ˆ','9-5':'ì¶”ì„ ì—°íœ´','9-6':'ì¶”ì„','9-7':'ì¶”ì„ ì—°íœ´','9-8':'ì¶”ì„ ëŒ€ì²´ê³µíœ´ì¼','9-3':'ê°œì²œì ˆ','9-9':'í•œê¸€ë‚ ','11-25':'ì„±íƒ„ì ˆ'}};
    function checkHoliday(date){const y=date.getFullYear().toString();const m=date.getMonth();const d=date.getDate();const k=`${m}-${d}`;return holidays[y]&&holidays[y][k];}

    // ====== Supabase CRUD ======
    async function fetchEventsRange(startISO, endISO){
      const { data, error } = await supabase
        .from('events')
        .select('*')
        .gte('event_date', startISO)
        .lte('event_date', endISO)
        .order('event_date',{ascending:true});
      if (error){ console.error(error); return []; }
      return data || [];
    }

    async function fetchEventsForMonth(year, month){
      const start = new Date(year, month, 1).toISOString().slice(0,10);
      const end   = new Date(year, month+1, 0).toISOString().slice(0,10);
      const rows = await fetchEventsRange(start, end);
      const grouped = {};
      for (const ev of rows){
        const d = new Date(ev.event_date);
        const key = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push({
          id: ev.id, department: ev.department,
          title: `[${ev.department}] ${ev.title}`,
          description: ev.description, time: ev.time,
          location: ev.location, type: ev.type,
          urgentAlert: !!ev.urgent_alert,
        });
      }
      return grouped;
    }

    async function insertEventDB(payload){
      const { data, error } = await supabase.from('events').insert({
        event_date: payload.eventDate, department: payload.department, title: payload.title,
        description: payload.description || null, time: payload.time || null,
        location: payload.location || null, type: payload.type || 'íšŒì˜',
        urgent_alert: !!payload.urgentAlert
      }).select().single();
      if (error){ throw error; }
      return data;
    }

    async function updateEventDB(id, payload){
      const { data, error } = await supabase.from('events').update({
        department: payload.department, title: payload.title,
        description: payload.description || null, time: payload.time || null,
        location: payload.location || null, type: payload.type || 'íšŒì˜',
        urgent_alert: !!payload.urgentAlert
      }).eq('id', id).select().single();
      if (error){ throw error; }
      return data;
    }

    async function deleteEventDB(id){
      const { error } = await supabase.from('events').delete().eq('id', id);
      if (error){ throw error; }
    }

    async function fetchMemos(){
      const { data, error } = await supabase.from('memos').select('*').order('created_at',{ascending:false}).limit(200);
      if (error){ console.error(error); return []; }
      return data || [];
    }

    async function insertMemoDB({department, content, password}){
      const password_hash = password ? await sha256(password) : null;
      const { data, error } = await supabase.from('memos').insert({
        department, content, password_hash
      }).select().single();
      if (error){ throw error; }
      return data;
    }

    async function deleteMemoDB(id, inputPassword){
      const { data: memo, error } = await supabase.from('memos').select('id,password_hash').eq('id', id).single();
      if (error || !memo) throw error || new Error('ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.');
      const hash = await sha256(inputPassword);
      if (memo.password_hash && memo.password_hash !== hash) throw new Error('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      const { error: delErr } = await supabase.from('memos').delete().eq('id', id);
      if (delErr) throw delErr;
    }

    // Storage
    async function uploadImageToStorage(file){
      const fileName = `${crypto.randomUUID()}_${file.name}`;
      const { data, error } = await supabase.storage.from('uploads').upload(fileName, file, { upsert:false });
      if (error){ throw error; }
      const { data: { publicUrl } } = supabase.storage.from('uploads').getPublicUrl(data.path);
      return { path: data.path, url: publicUrl };
    }

    // ====== ì´ˆê¸° êµ¬ë™ ======
    document.addEventListener('DOMContentLoaded', async () => {
      setupEventListeners();
      await refreshMonthData();
      updateCalendar();
      updateUrgentTasks();
      updateLastModified();
      await refreshMemos();
    });

    async function refreshMonthData(){
      const y = currentDate.getFullYear();
      const m = currentDate.getMonth();
      events = await fetchEventsForMonth(y, m);
    }

    async function refreshMemos(){
      const rows = await fetchMemos();
      memos = rows.map(r => ({
        id: r.id,
        department: r.department,
        content: `[${r.department}] ${r.content}`,
        date: new Date(r.created_at).toLocaleString('ko-KR')
      }));
      updateMemoList();
    }

    // ====== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ======
    function setupEventListeners(){
      document.getElementById('monthViewBtn').addEventListener('click', ()=>switchView('month'));
      document.getElementById('weekViewBtn').addEventListener('click', ()=>switchView('week'));
      document.getElementById('prevBtn').addEventListener('click', async ()=>{
        if (currentView==='month'){ currentDate.setMonth(currentDate.getMonth()-1); await refreshMonthData(); }
        else { currentDate.setDate(currentDate.getDate()-7); }
        updateCalendar(); updateUrgentTasks();
      });
      document.getElementById('nextBtn').addEventListener('click', async ()=>{
        if (currentView==='month'){ currentDate.setMonth(currentDate.getMonth()+1); await refreshMonthData(); }
        else { currentDate.setDate(currentDate.getDate()+7); }
        updateCalendar(); updateUrgentTasks();
      });

      document.getElementById('addEventBtn').addEventListener('click', openEventModal);
      document.getElementById('eventForm').addEventListener('submit', addEvent);
      document.getElementById('cancelEventBtn').addEventListener('click', closeEventModal);

      document.getElementById('addMemoBtn').addEventListener('click', openMemoModal);
      document.getElementById('memoForm').addEventListener('submit', addMemo);
      document.getElementById('cancelMemoBtn').addEventListener('click', closeMemoModal);
      document.getElementById('closeMemoDetailBtn').addEventListener('click', closeMemoDetailModal);
      document.getElementById('deleteMemoBtn').addEventListener('click', openPasswordModal);
      document.getElementById('passwordForm').addEventListener('submit', deleteMemo);
      document.getElementById('cancelPasswordBtn').addEventListener('click', closePasswordModal);

      document.getElementById('closeEventDetailBtn').addEventListener('click', closeEventDetailModal);
      document.getElementById('editEventBtn').addEventListener('click', editEvent);
      document.getElementById('deleteEventBtn').addEventListener('click', deleteEvent);

      document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
    }

    // ====== ë·° ì „í™˜ ======
    function switchView(view){
      currentView = view;
      const monthBtn=document.getElementById('monthViewBtn');
      const weekBtn=document.getElementById('weekViewBtn');
      const monthView=document.getElementById('monthView');
      const weekView=document.getElementById('weekView');
      if(view==='month'){
        monthBtn.className='px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium';
        weekBtn.className='px-6 py-2 bg-white text-green-600 rounded-lg hover:bg-green-50 transition-colors font-medium border border-green-600';
        monthView.classList.remove('hidden'); weekView.classList.add('hidden');
      }else{
        weekBtn.className='px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium';
        monthBtn.className='px-6 py-2 bg-white text-green-600 rounded-lg hover:bg-green-50 transition-colors font-medium border border-green-600';
        weekView.classList.remove('hidden'); monthView.classList.add('hidden');
      }
      updateCalendar();
    }

    function navigateCalendar(direction){
      if(currentView==='month'){ currentDate.setMonth(currentDate.getMonth()+direction); }
      else{ currentDate.setDate(currentDate.getDate()+(direction*7)); }
      updateCalendar();
    }

    function updateCalendar(){
      if(currentView==='month'){ updateMonthCalendar(); }
      else{ updateWeekCalendar(); }
    }

    // ====== ë‹¬ë ¥ ë Œë” (ì´í•˜ëŠ” ê¸°ì¡´ ë¡œì§ ìœ ì§€) ======
    function updateMonthCalendar(){
      const year=currentDate.getFullYear(); const month=currentDate.getMonth();
      document.getElementById('calendarTitle').textContent = `${year}ë…„ ${month+1}ì›”`;
      const firstDay=new Date(year,month,1);
      const startDate=new Date(firstDay); startDate.setDate(startDate.getDate()-firstDay.getDay());
      const calendar=document.getElementById('monthCalendar'); calendar.innerHTML='';

      for(let i=0;i<42;i++){
        const date=new Date(startDate); date.setDate(startDate.getDate()+i);
        const dayElement=document.createElement('div'); dayElement.className='calendar-day border border-green-200 rounded-lg p-2 cursor-pointer';
        const dayOfWeek=date.getDay(); const isHoliday=checkHoliday(date);
        if (date.getMonth()!==month){ dayElement.classList.add('text-gray-400');}
        else if(isHoliday||dayOfWeek===0){ dayElement.classList.add('text-red-600');}
        else if(dayOfWeek===6){ dayElement.classList.add('text-blue-600');}

        const dateKey = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
        const dayEvents = events[dateKey] || [];
        dayElement.innerHTML = `
          <div class="font-medium">${date.getDate()}</div>
          <div class="text-xs space-y-1 mt-1">
            ${dayEvents.map(ev=>`
              <div class="bg-green-200 text-green-800 px-1 py-0.5 rounded text-xs truncate cursor-pointer hover:bg-green-300"
                   onclick="event.stopPropagation(); openEventDetail('${dateKey}','${ev.id}')">${ev.title}</div>
            `).join('')}
          </div>`;
        dayElement.addEventListener('click', ()=>{ selectedDate=dateKey; openEventModal(); });
        calendar.appendChild(dayElement);
      }
    }

    function updateWeekCalendar(){
      const startOfWeek=new Date(currentDate); startOfWeek.setDate(currentDate.getDate()-currentDate.getDay());
      const endOfWeek=new Date(startOfWeek); endOfWeek.setDate(startOfWeek.getDate()+6);
      let weekTitle;
      if(startOfWeek.getFullYear()===endOfWeek.getFullYear() && startOfWeek.getMonth()===endOfWeek.getMonth()){
        const weekNumber=Math.ceil((currentDate.getDate()+new Date(currentDate.getFullYear(), currentDate.getMonth(),1).getDay())/7);
        weekTitle=`${startOfWeek.getFullYear()}ë…„ ${startOfWeek.getMonth()+1}ì›” ${weekNumber}ì£¼`;
      }else if(startOfWeek.getFullYear()===endOfWeek.getFullYear()){
        const s=Math.ceil((startOfWeek.getDate()+new Date(startOfWeek.getFullYear(),startOfWeek.getMonth(),1).getDay())/7);
        const e=Math.ceil((endOfWeek.getDate()+new Date(endOfWeek.getFullYear(),endOfWeek.getMonth(),1).getDay())/7);
        weekTitle=`${startOfWeek.getFullYear()}ë…„ ${startOfWeek.getMonth()+1}ì›” ${s}ì£¼~${endOfWeek.getMonth()+1}ì›” ${e}ì£¼`;
      }else{
        const s=Math.ceil((startOfWeek.getDate()+new Date(startOfWeek.getFullYear(),startOfWeek.getMonth(),1).getDay())/7);
        const e=Math.ceil((endOfWeek.getDate()+new Date(endOfWeek.getFullYear(),endOfWeek.getMonth(),1).getDay())/7);
        weekTitle=`${startOfWeek.getFullYear()}ë…„ ${startOfWeek.getMonth()+1}ì›” ${s}ì£¼~${endOfWeek.getFullYear()}ë…„ ${endOfWeek.getMonth()+1}ì›” ${e}ì£¼`;
      }
      document.getElementById('calendarTitle').textContent = weekTitle;

      const calendar=document.getElementById('weekCalendar'); calendar.innerHTML='';
      for(let i=0;i<7;i++){
        const date=new Date(startOfWeek); date.setDate(startOfWeek.getDate()+i);
        const dateKey = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
        const dayEvents = events[dateKey] || [];
        const dayElement=document.createElement('div'); dayElement.className='week-day border border-green-200 rounded-lg p-3 cursor-pointer';
        const dayOfWeek=date.getDay(); const isHoliday=checkHoliday(date);
        let dateColorClass='text-green-800';
        if(isHoliday||dayOfWeek===0) dateColorClass='text-red-600';
        else if(dayOfWeek===6) dateColorClass='text-blue-600';

        dayElement.innerHTML = `
          <div class="font-bold ${dateColorClass} mb-2">${date.getDate()}ì¼</div>
          <div class="space-y-2">
            ${dayEvents.map(ev=>`
              <div class="bg-green-100 border-l-4 border-green-500 p-2 rounded cursor-pointer hover:bg-green-200"
                   onclick="event.stopPropagation(); openEventDetail('${dateKey}','${ev.id}')">
                <div class="font-medium text-green-800">${ev.title}</div>
                <div class="text-xs text-green-600">${ev.time || ''} ${ev.location || ''}</div>
                <div class="text-xs text-green-500">${ev.type}</div>
              </div>
            `).join('')}
          </div>`;
        dayElement.addEventListener('click', ()=>{ selectedDate=dateKey; openEventModal(); });
        calendar.appendChild(dayElement);
      }
      updateUrgentTasks();
    }

    // ====== ì¼ì • ì¶”ê°€/í¸ì§‘/ì‚­ì œ ======
    function openEventModal(){
      const modalTitle=document.querySelector('#eventModal h3');
      modalTitle.textContent = isEditingEvent ? 'ì¼ì • í¸ì§‘' : 'ì¼ì • ì¶”ê°€';
      document.getElementById('eventModal').classList.remove('hidden');
      document.getElementById('eventModal').classList.add('flex');
    }
    function closeEventModal(){
      document.getElementById('eventModal').classList.add('hidden');
      document.getElementById('eventModal').classList.remove('flex');
      document.getElementById('eventForm').reset();
      selectedDate=null; isEditingEvent=false; currentEventId=null;
    }

    async function addEvent(e){
      e.preventDefault();
      const department=document.getElementById('eventDepartment').value;
      const title=document.getElementById('eventTitle').value;
      const description=document.getElementById('eventDescription').value;
      const time=document.getElementById('eventTime').value;
      const location=document.getElementById('eventLocation').value;
      const type=document.getElementById('eventType').value;
      const urgentAlert=document.getElementById('urgentAlert').checked;
      const base = selectedDate ? selectedDate.split('-').map(Number) : [currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate()];
      const eventDate = new Date(base[0], base[1], base[2]).toISOString().slice(0,10);

      try{
        if (isEditingEvent && currentEventId){
          await updateEventDB(currentEventId, {department, title, description, time, location, type, urgentAlert});
        }else{
          await insertEventDB({eventDate, department, title, description, time, location, type, urgentAlert});
        }
        await refreshMonthData();
        updateCalendar();
        closeEventModal();
        updateLastModified();
        updateUrgentTasks();
      }catch(err){ console.error(err); alert(err.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
    }

    function openEventDetail(dateKey, eventId){
      const ev = (events[dateKey] || []).find(e=> e.id===eventId);
      if(!ev) return;
      currentEventId = eventId; selectedDate = dateKey;
      document.getElementById('eventDetailContent').innerHTML = `
        <div class="bg-white bg-opacity-50 p-3 rounded-lg">
          <div class="font-bold text-green-800 text-lg mb-2">${ev.title}</div>
          ${ev.description ? `<div class="text-green-700 mb-2"><strong>ì„¤ëª…:</strong> ${ev.description}</div>`:''}
          ${ev.time ? `<div class="text-green-700 mb-2"><strong>ì‹œê°„:</strong> ${ev.time}</div>`:''}
          ${ev.location ? `<div class="text-green-700 mb-2"><strong>ì¥ì†Œ:</strong> ${ev.location}</div>`:''}
          <div class="text-green-700 mb-2"><strong>ìœ í˜•:</strong> ${ev.type}</div>
          <div class="text-green-700 mb-2"><strong>ë¶€ì„œ:</strong> ${ev.department}</div>
          ${ev.urgentAlert ? '<div class="text-red-600 text-sm">âš ï¸ ì œì¶œ ì„ë°• ì•ŒëŒ ì„¤ì •ë¨</div>':''}
        </div>`;
      document.getElementById('eventDetailModal').classList.remove('hidden');
      document.getElementById('eventDetailModal').classList.add('flex');
    }

    function closeEventDetailModal(){
      document.getElementById('eventDetailModal').classList.add('hidden');
      document.getElementById('eventDetailModal').classList.remove('flex');
      currentEventId=null; selectedDate=null;
    }

    function editEvent(){
      if (!currentEventId || !selectedDate) return;
      const ev = (events[selectedDate]||[]).find(e=> e.id===currentEventId);
      if (!ev) return;
      isEditingEvent=true;
      document.getElementById('eventDepartment').value = ev.department;
      document.getElementById('eventTitle').value = ev.title.replace(`[${ev.department}] `,'');
      document.getElementById('eventDescription').value = ev.description||'';
      document.getElementById('eventTime').value = ev.time||'';
      document.getElementById('eventLocation').value = ev.location||'';
      document.getElementById('eventType').value = ev.type||'íšŒì˜';
      document.getElementById('urgentAlert').checked = !!ev.urgentAlert;
      closeEventDetailModal(); openEventModal();
    }

    async function deleteEvent(){
      if(!currentEventId){ alert('ì‚­ì œí•  ì¼ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      if(!confirm('ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try{
        await deleteEventDB(currentEventId);
        await refreshMonthData();
        updateCalendar();
        updateUrgentTasks();
        updateLastModified();
        closeEventDetailModal();
        alert('ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }catch(err){ console.error(err); alert(err.message || 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜'); }
    }

    // ====== ë©”ëª¨ ======
    function openMemoModal(){ document.getElementById('memoModal').classList.remove('hidden'); document.getElementById('memoModal').classList.add('flex'); }
    function closeMemoModal(){ document.getElementById('memoModal').classList.add('hidden'); document.getElementById('memoModal').classList.remove('flex'); document.getElementById('memoForm').reset(); }

    async function addMemo(e){
      e.preventDefault();
      const department=document.getElementById('memoDepartment').value;
      const content=document.getElementById('memoContent').value;
      const password=document.getElementById('memoPassword').value;
      try{
        await insertMemoDB({department, content, password});
        await refreshMemos();
        closeMemoModal();
        updateLastModified();
      }catch(err){ console.error(err); alert(err.message || 'ë©”ëª¨ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜'); }
    }

    function updateMemoList(){
      const memoList=document.getElementById('memoList');
      memoList.innerHTML = memos.map((m, idx)=>`
        <div class="memo-item bg-white bg-opacity-50 p-3 rounded-lg cursor-pointer hover:bg-opacity-70" onclick="openMemoDetail(${idx})">
          <div class="font-medium text-green-800 truncate">${m.content.substring(0,30)}${m.content.length>30?'...':''}</div>
          <div class="text-xs text-green-600">${m.date}</div>
        </div>`).join('');
    }

    function openMemoDetail(index){
      currentMemoIndex = index;
      const memo = memos[index];
      document.getElementById('memoDetailContent').innerHTML = `
        <div class="whitespace-pre-wrap">${memo.content}</div>
        <div class="text-xs text-green-600 mt-2">ì‘ì„±ì¼: ${memo.date}</div>`;
      document.getElementById('memoDetailModal').classList.remove('hidden');
      document.getElementById('memoDetailModal').classList.add('flex');
    }

    function closeMemoDetailModal(){ document.getElementById('memoDetailModal').classList.add('hidden'); document.getElementById('memoDetailModal').classList.remove('flex'); currentMemoIndex=null; }
    function openPasswordModal(){ document.getElementById('passwordModal').classList.remove('hidden'); document.getElementById('passwordModal').classList.add('flex'); }
    function closePasswordModal(){ document.getElementById('passwordModal').classList.add('hidden'); document.getElementById('passwordModal').classList.remove('flex'); document.getElementById('passwordForm').reset(); }

    async function deleteMemo(e){
      e.preventDefault();
      const inputPw=document.getElementById('deletePassword').value;
      const memo = memos[currentMemoIndex];
      if(!memo){ alert('ë©”ëª¨ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      try{
        await deleteMemoDB(memo.id, inputPw);
        closeMemoDetailModal(); closePasswordModal();
        await refreshMemos();
        updateLastModified();
      }catch(err){ alert(err.message || 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); }
    }

    // ====== ì œì¶œ ì„ë°• ======
    function updateUrgentTasks(){
      const urgentTasks=document.getElementById('urgentTasks');
      const today=new Date(); today.setHours(0,0,0,0);
      const urgentList=[];
      Object.keys(events).forEach(dateKey=>{
        const [y,m,d]=dateKey.split('-').map(Number);
        const eventDate=new Date(y,m,d); eventDate.setHours(0,0,0,0);
        const daysDiff=Math.ceil((eventDate - today)/(1000*60*60*24));
        (events[dateKey]||[]).forEach(ev=>{
          if(ev.urgentAlert && daysDiff<=3 && daysDiff>=0){
            urgentList.push({...ev, daysLeft:daysDiff, dateKey});
          }
        });
      });
      urgentList.sort((a,b)=>a.daysLeft-b.daysLeft);
      if(urgentList.length===0){
        urgentTasks.innerHTML='<div class="text-green-600 text-center py-4">í˜„ì¬ ì œì¶œ ì„ë°• í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      }else{
        urgentTasks.innerHTML = urgentList.map(t=>{
          let urgencyClass='bg-yellow-100 border-yellow-500', textClass='text-yellow-800', dateText='text-yellow-600';
          if(t.daysLeft===0){ urgencyClass='bg-red-100 border-red-500'; textClass='text-red-800'; dateText='text-red-600';}
          else if(t.daysLeft===1){ urgencyClass='bg-orange-100 border-orange-500'; textClass='text-orange-800'; dateText='text-orange-600';}
          return `
            <div class="${urgencyClass} border-l-4 p-3 rounded cursor-pointer hover:bg-opacity-80"
                 onclick="openEventDetail('${t.dateKey}','${t.id}')">
              <p class="${textClass} font-medium">${t.title}</p>
              <p class="${dateText} text-sm">ë§ˆê°: ${t.daysLeft===0?'ì˜¤ëŠ˜':t.daysLeft+'ì¼ í›„'}</p>
              ${t.time?`<p class="${dateText} text-xs">ì‹œê°„: ${t.time}</p>`:''}
              ${t.location?`<p class="${dateText} text-xs">ì¥ì†Œ: ${t.location}</p>`:''}
            </div>`;
        }).join('');
      }
    }

    // ====== ì´ë¯¸ì§€ ì—…ë¡œë“œ (Storage) ======
    async function handleImageUpload(e){
      const file=e.target.files[0];
      const uploadedImages=document.getElementById('uploadedImages');
      const uploadButton=document.getElementById('uploadButton');
      if(file && file.type.startsWith('image/')){
        try{
          const { url } = await uploadImageToStorage(file);
          uploadedImages.innerHTML='';
          uploadButton.classList.add('hidden'); uploadedImages.classList.remove('hidden');
          const imageDiv=document.createElement('div');
          imageDiv.className='relative group cursor-pointer w-full';
          imageDiv.innerHTML=`
            <img src="${url}" class="w-full h-auto rounded-lg shadow-md">
            <div class="absolute inset-0 bg-black bg-opacity-50 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center gap-2">
              <button onclick="editImage(this)" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">ìˆ˜ì •</button>
              <button onclick="deleteImage(this)" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">ì‚­ì œ</button>
            </div>`;
          uploadedImages.appendChild(imageDiv);
          updateLastModified();
        }catch(err){ console.error(err); alert('ì—…ë¡œë“œ ì‹¤íŒ¨: '+(err.message||'')); }
      }
      e.target.value='';
    }

    function editImage(button){
      const fileInput=document.createElement('input'); fileInput.type='file'; fileInput.accept='image/*';
      fileInput.onchange=async (e)=>{
        const file=e.target.files[0]; if(!(file&&file.type.startsWith('image/'))) return;
        try{
          const { url } = await uploadImageToStorage(file);
          const imageDiv=button.closest('.group'); const img=imageDiv.querySelector('img'); img.src=url; updateLastModified();
        }catch(err){ alert('ì—…ë¡œë“œ ì‹¤íŒ¨'); }
      };
      fileInput.click();
    }

    function deleteImage(button){
      const uploadedImages=document.getElementById('uploadedImages');
      const uploadButton=document.getElementById('uploadButton');
      uploadedImages.innerHTML=''; uploadedImages.classList.add('hidden'); uploadButton.classList.remove('hidden');
      updateLastModified();
    }

    function updateLastModified(){
      const now=new Date(); document.getElementById('lastModified').textContent = now.toLocaleString('ko-KR');
    }
  </script>
</body>
</html>
