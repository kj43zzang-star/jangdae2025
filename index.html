<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>대전장대중학교 업무 안내</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body{background:linear-gradient(135deg,#f0fdf4 0%,#dcfce7 50%,#bbf7d0 100%);font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    .glass-effect{background:rgba(255,255,255,.85);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.9);box-shadow:0 8px 32px rgba(0,0,0,.1)}
    .modal-glass{background:rgba(255,255,255,.95);backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,.8)}
    .calendar-day{min-height:72px;transition:all .3s ease}
    .calendar-day:hover{background:rgba(255,255,255,.3)}
    .week-day{min-height:110px}
    .memo-item{transition:transform .2s ease}
    .memo-item:hover{transform:translateY(-2px)}
    @media (max-width: 640px){
      .calendar-day{min-height:56px;padding:6px}
      .week-day{min-height:90px;padding:10px}
      .calendar-day .text-xs,.week-day .text-xs{font-size:.7rem}
      .truncate{white-space:normal;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    }
  </style>

  <script>

    // 안전한 UUID
function safeUUID(){
  return (crypto.randomUUID?.() || ('f_' + Date.now().toString(36)));
}

// 파일명을 ASCII로 정리해서 스토리지 키 생성
function toSafeKey(file){
  const orig = file.name;
  const dot  = orig.lastIndexOf('.');
  const base = (dot > -1 ? orig.slice(0, dot) : orig) || 'file';
  const ext  = (dot > -1 ? orig.slice(dot + 1) : 'bin').toLowerCase();

  // 비ASCII 제거 + 안전하지 않은 문자 하이픈으로 교체
  const asciiBase = base
    .normalize('NFKD')
    .replace(/[^\x00-\x7F]/g, '')      // 비ASCII 제거
    .replace(/[^a-z0-9._-]+/gi, '-')   // 안전하지 않은 문자 → -
    .replace(/-+/g, '-')               // 중복 - 정리
    .replace(/^-|-$/g, '')             // 앞뒤 - 제거
    .toLowerCase() || 'file';

  // 정책이 'public' 폴더를 요구해도 동작하도록 public/ 접두어 사용
  return `public/${safeUUID()}-${asciiBase}.${ext}`;
}
    
    /* --- Supabase 초기화 --- */
    const SUPABASE_URL = "https://crwpivblcgvnhmtphlhm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNyd3BpdmJsY2d2bmhtdHBobGhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxODIxNjQsImV4cCI6MjA3NDc1ODE2NH0.7O8-w4NFKBlo0h9uESWt5sCGd-XWoRnsf_Pu3cpkcZc";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {auth:{persistSession:true,autoRefreshToken:true}});

    async function sha256(text){
      const enc=new TextEncoder().encode(text);
      const buf=await crypto.subtle.digest('SHA-256',enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
  </script>
</head>

<body class="min-h-screen p-3 sm:p-4">
  <div class="max-w-7xl mx-auto">
    <!-- 헤더 -->
    <div class="glass-effect rounded-2xl p-6 mb-6 shadow-lg">
      <div class="flex flex-col gap-4 sm:flex-row sm:justify-between sm:items-center">
        <div class="flex items-center gap-4">
          <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center shadow-lg">
            <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6l2-1.09V17h2V9L12 3zm6.82 6L12 12.72 5.18 9 12 5.28 18.82 9zM17 15.99l-5 2.73-5-2.73v-3.72L12 15l5-2.73v3.72z"/>
            </svg>
          </div>
          <h1 class="text-2xl sm:text-3xl font-bold text-green-800">대전장대중학교 월간/주간 업무 계획</h1>
        </div>
        <div class="flex gap-2 flex-col sm:flex-row">
          <button id="monthViewBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">월간 보기</button>
          <button id="weekViewBtn" class="px-6 py-2 bg-white text-green-600 rounded-lg hover:bg-green-50 transition-colors font-medium border border-green-600">주간 보기</button>
        </div>
      </div>
    </div>

    <!-- 제출임박 & 퀵메모존 -->
    <div class="grid md:grid-cols-2 gap-6 mb-6">
      <div class="glass-effect rounded-2xl p-6 shadow-lg">
        <h2 class="text-xl font-bold text-green-800 mb-4 flex items-center"><span class="mr-2">⚠️</span>제출임박</h2>
        <div id="urgentTasks" class="space-y-3"></div>
      </div>

      <div class="glass-effect rounded-2xl p-6 shadow-lg">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-green-800 flex items-center"><span class="mr-2">📝</span>퀵 메모존</h2>
          <button id="addMemoBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">메모 추가</button>
        </div>
        <div id="memoList" class="space-y-2 max-h-40 overflow-y-auto"></div>
      </div>
    </div>

    <!-- 월별/주별 일정 -->
    <div class="glass-effect rounded-2xl p-6 mb-6 shadow-lg">
      <div id="calendarHeader" class="flex justify-between items-center mb-6">
        <button id="prevBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">◀ 이전</button>
        <h2 id="calendarTitle" class="text-2xl font-bold text-green-800">2025년 1월</h2>
        <button id="nextBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">다음 ▶</button>
      </div>

      <!-- 월간: 가로 스크롤 래퍼 -->
      <div id="monthView" class="calendar-view">
        <div class="overflow-x-auto -mx-2 px-2">
          <div class="grid min-w-[700px] grid-cols-7 gap-1 mb-2">
            <div class="text-center font-bold text-red-600 p-2">일</div>
            <div class="text-center font-bold text-green-800 p-2">월</div>
            <div class="text-center font-bold text-green-800 p-2">화</div>
            <div class="text-center font-bold text-green-800 p-2">수</div>
            <div class="text-center font-bold text-green-800 p-2">목</div>
            <div class="text-center font-bold text-green-800 p-2">금</div>
            <div class="text-center font-bold text-blue-600 p-2">토</div>
          </div>
        </div>
        <div class="overflow-x-auto -mx-2 px-2">
          <div id="monthCalendar" class="grid min-w-[700px] grid-cols-7 gap-1"></div>
        </div>
      </div>

      <!-- 주간: 1→2→7열 반응형 -->
      <div id="weekView" class="calendar-view hidden">
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-7 gap-2">
          <div class="text-center font-bold text-red-600 p-2">일</div>
          <div class="text-center font-bold text-green-800 p-2">월</div>
          <div class="text-center font-bold text-green-800 p-2">화</div>
          <div class="text-center font-bold text-green-800 p-2">수</div>
          <div class="text-center font-bold text-green-800 p-2">목</div>
          <div class="text-center font-bold text-green-800 p-2">금</div>
          <div class="text-center font-bold text-blue-600 p-2">토</div>
        </div>
        <div id="weekCalendar" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-7 gap-2 mt-2"></div>
      </div>

      <button id="addEventBtn" class="mt-6 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium w-full">일정 추가</button>
    </div>

    <!-- 자료 집계 -->
    <div class="glass-effect rounded-2xl p-6 shadow-lg">
      <h2 class="text-xl font-bold text-green-800 mb-4 flex items-center"><span class="mr-2">📊</span>자료 집계</h2>
      <div id="uploadArea" class="border-2 border-dashed border-green-400 rounded-lg text-center mb-4">
        <input type="file" id="imageUpload" accept="image/*" class="hidden">
        <div id="uploadButton" class="p-8">
          <button onclick="document.getElementById('imageUpload').click()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">📷 이미지 업로드</button>
          <p class="text-green-700 mt-2">화면 캡쳐 이미지를 업로드하세요</p>
        </div>
        <div id="uploadedImages" class="p-4 hidden w-full"></div>
        <div class="text-right text-green-700 text-sm mt-4 px-4 pb-4">
          최종 수정: <span id="lastModified">-</span>
        </div>
      </div>
    </div>
  </div>

  <!-- 모달들 -->
  <div id="eventModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="modal-glass rounded-2xl p-6 max-w-md w-[95vw] mx-4 max-h-[90vh] overflow-y-auto shadow-2xl">
      <h3 class="text-xl font-bold text-green-800 mb-4">일정 추가</h3>
      <form id="eventForm">
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">부서</label>
          <select id="eventDepartment" class="w-full p-3 border border-green-300 rounded-lg" required>
            <option value="">부서를 선택하세요</option>
            <option>교무운영부</option><option>교육연구부</option><option>생활안전부</option>
            <option>교육정보탐구부</option><option>체육보건부</option><option>진로진학상담부</option>
            <option>지역사회환경부</option><option>학력신장방과후학교부</option>
            <option>1학년부</option><option>2학년부</option><option>3학년부</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">제목</label>
          <input type="text" id="eventTitle" class="w-full p-3 border border-green-300 rounded-lg" required>
        </div>
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">설명</label>
          <textarea id="eventDescription" class="w-full p-3 border border-green-300 rounded-lg h-20"></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">시간</label>
          <input type="time" id="eventTime" class="w-full p-3 border border-green-300 rounded-lg">
        </div>
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">장소</label>
          <input type="text" id="eventLocation" class="w-full p-3 border border-green-300 rounded-lg">
        </div>
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">유형</label>
          <select id="eventType" class="w-full p-3 border border-green-300 rounded-lg">
            <option>회의</option><option>제출</option><option>학사일정</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="flex items-center">
            <input type="checkbox" id="urgentAlert" class="mr-2">
            <span class="text-green-800">제출 임박 알람 표시</span>
          </label>
        </div>
        <div class="flex gap-3">
          <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">추가</button>
          <button type="button" id="cancelEventBtn" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">취소</button>
        </div>
      </form>
    </div>
  </div>

  <div id="memoModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="modal-glass rounded-2xl p-6 max-w-md w-[95vw] mx-4 shadow-2xl">
      <h3 class="text-xl font-bold text-green-800 mb-4">메모 추가</h3>
      <form id="memoForm">
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">부서</label>
          <select id="memoDepartment" class="w-full p-3 border border-green-300 rounded-lg" required>
            <option value="">부서를 선택하세요</option>
            <option>교무운영부</option><option>교육연구부</option><option>생활안전부</option>
            <option>교육정보탐구부</option><option>체육보건부</option><option>진로진학상담부</option>
            <option>지역사회환경부</option><option>학력신장방과후학교부</option>
            <option>1학년부</option><option>2학년부</option><option>3학년부</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">메모 내용</label>
          <textarea id="memoContent" class="w-full p-3 border border-green-300 rounded-lg h-24" required></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">삭제 비밀번호 (4자리 숫자)</label>
          <input type="password" id="memoPassword" class="w-full p-3 border border-green-300 rounded-lg" pattern="[0-9]{4}" maxlength="4" required>
        </div>
        <div class="flex gap-3">
          <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">추가</button>
          <button type="button" id="cancelMemoBtn" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">취소</button>
        </div>
      </form>
    </div>
  </div>

  <div id="memoDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="modal-glass rounded-2xl p-6 max-w-md w-[95vw] mx-4 shadow-2xl">
      <h3 class="text-xl font-bold text-green-800 mb-4">메모 상세</h3>
      <div id="memoDetailContent" class="mb-4 p-3 bg-white bg-opacity-50 rounded-lg min-h-[100px]"></div>
      <div class="flex gap-3">
        <button id="deleteMemoBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">삭제</button>
        <button id="closeMemoDetailBtn" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">닫기</button>
      </div>
    </div>
  </div>

  <div id="eventDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="modal-glass rounded-2xl p-6 max-w-md w-[95vw] mx-4 max-h-[90vh] overflow-y-auto shadow-2xl">
      <h3 class="text-xl font-bold text-green-800 mb-4">일정 상세</h3>
      <div id="eventDetailContent" class="mb-4 space-y-3"></div>
      <div class="flex gap-3">
        <button id="editEventBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">편집</button>
        <button id="deleteEventBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">삭제</button>
        <button id="closeEventDetailBtn" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">닫기</button>
      </div>
    </div>
  </div>

  <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="modal-glass rounded-2xl p-6 max-w-sm w-[95vw] mx-4 shadow-2xl">
      <h3 class="text-xl font-bold text-green-800 mb-4">비밀번호 확인</h3>
      <form id="passwordForm">
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">삭제 비밀번호 입력</label>
          <input type="password" id="deletePassword" class="w-full p-3 border border-green-300 rounded-lg" pattern="[0-9]{4}" maxlength="4" required>
        </div>
        <div class="flex gap-3">
          <button type="submit" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">삭제</button>
          <button type="button" id="cancelPasswordBtn" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">취소</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    /* ===== 상태 ===== */
    let currentDate=new Date(), currentView='month', selectedDate=null;
    let events={}, memos=[], currentMemoIndex=null, currentEventId=null, isEditingEvent=false;

    const holidays={'2025':{'0-1':'신정','0-27':'설날 연휴','0-28':'설날','0-29':'설날 연휴','2-1':'삼일절','2-3':'삼일절 대체공휴일','4-5':'어린이날','4-6':'부처님오신날','5-6':'현충일','7-15':'광복절','9-5':'추석 연휴','9-6':'추석','9-7':'추석 연휴','9-8':'추석 대체공휴일','9-3':'개천절','9-9':'한글날','11-25':'성탄절'}};
    function checkHoliday(date){const y=date.getFullYear().toString(),m=date.getMonth(),d=date.getDate(),k=`${m}-${d}`;return holidays[y]&&holidays[y][k];}

    /* ===== Supabase CRUD ===== */
    async function fetchEventsForMonth(year,month){
      const start=new Date(year,month,1).toISOString().slice(0,10);
      const end=new Date(year,month+1,0).toISOString().slice(0,10);
      const {data,error}=await supabase.from('events').select('*').gte('event_date',start).lte('event_date',end).order('event_date',{ascending:true});
      if(error){console.error(error);return {};}
      const grouped={};
      (data||[]).forEach(ev=>{
        const d=new Date(ev.event_date);
        const k=`${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
        if(!grouped[k])grouped[k]=[];
        grouped[k].push({
          id:ev.id,department:ev.department,
          title:`[${ev.department}] ${ev.title}`,
          description:ev.description,time:ev.time,
          location:ev.location,type:ev.type,
          urgentAlert:!!ev.urgent_alert
        });
      });
      return grouped;
    }
    async function insertEventDB(p){
      const {data,error}=await supabase.from('events')
        .insert({event_date:p.eventDate,department:p.department,title:p.title,description:p.description||null,time:p.time||null,location:p.location||null,type:p.type||'회의',urgent_alert:!!p.urgentAlert})
        .select().single();
      if(error)throw error; return data;
    }
    async function updateEventDB(id,p){
      const {data,error}=await supabase.from('events')
        .update({department:p.department,title:p.title,description:p.description||null,time:p.time||null,location:p.location||null,type:p.type||'회의',urgent_alert:!!p.urgentAlert})
        .eq('id',id).select().single();
      if(error)throw error; return data;
    }
    async function deleteEventDB(id){const {error}=await supabase.from('events').delete().eq('id',id);if(error)throw error;}

    async function fetchMemos(){
      const {data,error}=await supabase.from('memos').select('*').order('created_at',{ascending:false}).limit(200);
      if(error){console.error(error);return [];} return data||[];
    }
    async function insertMemoDB({department,content,password}){
      const password_hash=password?await sha256(password):null;
      const {data,error}=await supabase.from('memos').insert({department,content,password_hash}).select().single();
      if(error)throw error; return data;
    }
    async function deleteMemoDB(id,inputPassword){
      const {data:memo,error}=await supabase.from('memos').select('id,password_hash').eq('id',id).single();
      if(error||!memo)throw error||new Error('메모 없음');
      const hash=await sha256(inputPassword);
      if(memo.password_hash&&memo.password_hash!==hash)throw new Error('비밀번호가 일치하지 않습니다.');
      const {error:delErr}=await supabase.from('memos').delete().eq('id',id);
      if(delErr)throw delErr;
    }
    async function uploadImageToStorage(file){
  // 안전한 키 생성 (ASCII, public/ 폴더 하위)
  const key = toSafeKey(file);

  const { data, error } = await supabase
    .storage
    .from('uploads')
    .upload(key, file, { upsert: false });

  if (error) {
    console.error('[upload error]', error);
    throw error;
  }

  const { data: { publicUrl } } =
    supabase.storage.from('uploads').getPublicUrl(data.path);

  return { path: data.path, url: publicUrl };
}


    /* ===== 초기화 ===== */
    document.addEventListener('DOMContentLoaded', async ()=>{
      setupEventListeners();
      await refreshMonthData();
      updateCalendar();
      updateUrgentTasks();
      updateLastModified();
      await refreshMemos();
    });

    async function refreshMonthData(){
      try{
        events=await fetchEventsForMonth(currentDate.getFullYear(),currentDate.getMonth());
      }catch{events={};}
    }
    async function refreshMemos(){
      const rows=await fetchMemos();
      memos=rows.map(r=>({id:r.id,department:r.department,content:`[${r.department}] ${r.content}`,date:new Date(r.created_at).toLocaleString('ko-KR')}));
      updateMemoList();
    }

    /* ===== 리스너 ===== */
    function setupEventListeners(){
      document.getElementById('monthViewBtn').addEventListener('click',()=>switchView('month'));
      document.getElementById('weekViewBtn').addEventListener('click',()=>switchView('week'));
      document.getElementById('prevBtn').addEventListener('click',async()=>{
        if(currentView==='month'){currentDate.setMonth(currentDate.getMonth()-1);await refreshMonthData();}
        else{currentDate.setDate(currentDate.getDate()-7);}
        updateCalendar();updateUrgentTasks();
      });
      document.getElementById('nextBtn').addEventListener('click',async()=>{
        if(currentView==='month'){currentDate.setMonth(currentDate.getMonth()+1);await refreshMonthData();}
        else{currentDate.setDate(currentDate.getDate()+7);}
        updateCalendar();updateUrgentTasks();
      });

      document.getElementById('addEventBtn').addEventListener('click',openEventModal);
      document.getElementById('eventForm').addEventListener('submit',addEvent);
      document.getElementById('cancelEventBtn').addEventListener('click',closeEventModal);

      document.getElementById('addMemoBtn').addEventListener('click',openMemoModal);
      document.getElementById('memoForm').addEventListener('submit',addMemo);
      document.getElementById('cancelMemoBtn').addEventListener('click',closeMemoModal);
      document.getElementById('closeMemoDetailBtn').addEventListener('click',closeMemoDetailModal);
      document.getElementById('deleteMemoBtn').addEventListener('click',openPasswordModal);
      document.getElementById('passwordForm').addEventListener('submit',deleteMemo);
      document.getElementById('cancelPasswordBtn').addEventListener('click',closePasswordModal);

      document.getElementById('closeEventDetailBtn').addEventListener('click',closeEventDetailModal);
      document.getElementById('editEventBtn').addEventListener('click',editEvent);
      document.getElementById('deleteEventBtn').addEventListener('click',deleteEvent);

      document.getElementById('imageUpload').addEventListener('change',handleImageUpload);
    }

    /* ===== 뷰 전환/달력 ===== */
    function switchView(view){
      currentView=view;
      const monthBtn=document.getElementById('monthViewBtn'),weekBtn=document.getElementById('weekViewBtn');
      const monthView=document.getElementById('monthView'),weekView=document.getElementById('weekView');
      if(view==='month'){
        monthBtn.className='px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium';
        weekBtn.className='px-6 py-2 bg-white text-green-600 rounded-lg hover:bg-green-50 transition-colors font-medium border border-green-600';
        monthView.classList.remove('hidden');weekView.classList.add('hidden');
      }else{
        weekBtn.className='px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium';
        monthBtn.className='px-6 py-2 bg-white text-green-600 rounded-lg hover:bg-green-50 transition-colors font-medium border border-green-600';
        weekView.classList.remove('hidden');monthView.classList.add('hidden');
      }
      updateCalendar();
    }

    function updateCalendar(){ if(currentView==='month') updateMonthCalendar(); else updateWeekCalendar(); }

    function updateMonthCalendar(){
      const year=currentDate.getFullYear(),month=currentDate.getMonth();
      document.getElementById('calendarTitle').textContent=`${year}년 ${month+1}월`;
      const firstDay=new Date(year,month,1); const startDate=new Date(firstDay); startDate.setDate(startDate.getDate()-firstDay.getDay());
      const calendar=document.getElementById('monthCalendar'); calendar.innerHTML='';
      for(let i=0;i<42;i++){
        const date=new Date(startDate); date.setDate(startDate.getDate()+i);
        const el=document.createElement('div'); el.className='calendar-day border border-green-200 rounded-lg p-2 cursor-pointer';
        const dow=date.getDay(), isHol=checkHoliday(date);
        if(date.getMonth()!==month) el.classList.add('text-gray-400'); else if(isHol||dow===0) el.classList.add('text-red-600'); else if(dow===6) el.classList.add('text-blue-600');
        const key=`${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`; const dayEvents=events[key]||[];
        el.innerHTML=`<div class="font-medium">${date.getDate()}</div>
          <div class="text-xs space-y-1 mt-1">
            ${dayEvents.map(e=>`
              <div class="bg-green-200 text-green-800 px-1 py-0.5 rounded text-xs truncate cursor-pointer hover:bg-green-300" onclick="openEventDetail('${key}','${e.id}'); return false;">
                ${e.title}
              </div>`).join('')}
          </div>`;
        el.addEventListener('click',()=>{selectedDate=key;openEventModal();});
        calendar.appendChild(el);
      }
    }

    function updateWeekCalendar(){
      const start=new Date(currentDate); start.setDate(currentDate.getDate()-currentDate.getDay());
      const end=new Date(start); end.setDate(start.getDate()+6);
      let title;
      if(start.getFullYear()===end.getFullYear() && start.getMonth()===end.getMonth()){
        const wn=Math.ceil((currentDate.getDate()+new Date(currentDate.getFullYear(),currentDate.getMonth(),1).getDay())/7);
        title=`${start.getFullYear()}년 ${start.getMonth()+1}월 ${wn}주`;
      }else if(start.getFullYear()===end.getFullYear()){
        const s=Math.ceil((start.getDate()+new Date(start.getFullYear(),start.getMonth(),1).getDay())/7);
        const e=Math.ceil((end.getDate()+new Date(end.getFullYear(),end.getMonth(),1).getDay())/7);
        title=`${start.getFullYear()}년 ${start.getMonth()+1}월 ${s}주~${end.getMonth()+1}월 ${e}주`;
      }else{
        const s=Math.ceil((start.getDate()+new Date(start.getFullYear(),start.getMonth(),1).getDay())/7);
        const e=Math.ceil((end.getDate()+new Date(end.getFullYear(),end.getMonth(),1).getDay())/7);
        title=`${start.getFullYear()}년 ${start.getMonth()+1}월 ${s}주~${end.getFullYear()}년 ${end.getMonth()+1}월 ${e}주`;
      }
      document.getElementById('calendarTitle').textContent=title;

      const calendar=document.getElementById('weekCalendar'); calendar.innerHTML='';
      for(let i=0;i<7;i++){
        const date=new Date(start); date.setDate(start.getDate()+i);
        const key=`${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`; const dayEvents=events[key]||[];
        const el=document.createElement('div'); el.className='week-day border border-green-200 rounded-lg p-3 cursor-pointer';
        const dow=date.getDay(), isHol=checkHoliday(date);
        let col='text-green-800'; if(isHol||dow===0) col='text-red-600'; else if(dow===6) col='text-blue-600';
        el.innerHTML=`<div class="font-bold ${col} mb-2">${date.getDate()}일</div>
          <div class="space-y-2">
            ${dayEvents.map(e=>`
              <div class="bg-green-100 border-l-4 border-green-500 p-2 rounded cursor-pointer hover:bg-green-200" onclick="openEventDetail('${key}','${e.id}'); return false;">
                <div class="font-medium text-green-800">${e.title}</div>
                <div class="text-xs text-green-600">${e.time||''} ${e.location||''}</div>
                <div class="text-xs text-green-500">${e.type}</div>
              </div>`).join('')}
          </div>`;
        el.addEventListener('click',()=>{selectedDate=key;openEventModal();});
        calendar.appendChild(el);
      }
      updateUrgentTasks();
    }

    /* ===== 일정 CRUD ===== */
    function openEventModal(){document.querySelector('#eventModal h3').textContent=isEditingEvent?'일정 편집':'일정 추가';document.getElementById('eventModal').classList.remove('hidden');document.getElementById('eventModal').classList.add('flex');}
    function closeEventModal(){document.getElementById('eventModal').classList.add('hidden');document.getElementById('eventModal').classList.remove('flex');document.getElementById('eventForm').reset();selectedDate=null;isEditingEvent=false;currentEventId=null;}

    async function addEvent(e){
      e.preventDefault();
      const department=document.getElementById('eventDepartment').value;
      const title=document.getElementById('eventTitle').value;
      const description=document.getElementById('eventDescription').value;
      const time=document.getElementById('eventTime').value;
      const location=document.getElementById('eventLocation').value;
      const type=document.getElementById('eventType').value;
      const urgentAlert=document.getElementById('urgentAlert').checked;
      const base=selectedDate?selectedDate.split('-').map(Number):[currentDate.getFullYear(),currentDate.getMonth(),currentDate.getDate()];
      const eventDate=new Date(base[0],base[1],base[2]).toISOString().slice(0,10);
      try{
        if(isEditingEvent && currentEventId) await updateEventDB(currentEventId,{department,title,description,time,location,type,urgentAlert});
        else await insertEventDB({eventDate,department,title,description,time,location,type,urgentAlert});
        await refreshMonthData(); updateCalendar(); closeEventModal(); updateLastModified(); updateUrgentTasks();
      }catch(err){alert(err.message||'오류가 발생했습니다.');}
    }

    function openEventDetail(dateKey,eventId){
      const ev=(events[dateKey]||[]).find(e=>e.id===eventId); if(!ev) return;
      currentEventId=eventId; selectedDate=dateKey;
      document.getElementById('eventDetailContent').innerHTML=`
        <div class="bg-white bg-opacity-50 p-3 rounded-lg">
          <div class="font-bold text-green-800 text-lg mb-2">${ev.title}</div>
          ${ev.description?`<div class="text-green-700 mb-2"><strong>설명:</strong> ${ev.description}</div>`:''}
          ${ev.time?`<div class="text-green-700 mb-2"><strong>시간:</strong> ${ev.time}</div>`:''}
          ${ev.location?`<div class="text-green-700 mb-2"><strong>장소:</strong> ${ev.location}</div>`:''}
          <div class="text-green-700 mb-2"><strong>유형:</strong> ${ev.type}</div>
          <div class="text-green-700 mb-2"><strong>부서:</strong> ${ev.department}</div>
          ${ev.urgentAlert?'<div class="text-red-600 text-sm">⚠️ 제출 임박 알람 설정됨</div>':''}
        </div>`;
      document.getElementById('eventDetailModal').classList.remove('hidden');document.getElementById('eventDetailModal').classList.add('flex');
    }

    function closeEventDetailModal(){document.getElementById('eventDetailModal').classList.add('hidden');document.getElementById('eventDetailModal').classList.remove('flex');currentEventId=null;selectedDate=null;}
    function editEvent(){if(!currentEventId||!selectedDate)return;const ev=(events[selectedDate]||[]).find(e=>e.id===currentEventId);if(!ev)return;isEditingEvent=true;document.getElementById('eventDepartment').value=ev.department;document.getElementById('eventTitle').value=ev.title.replace(`[${ev.department}] `,'');document.getElementById('eventDescription').value=ev.description||'';document.getElementById('eventTime').value=ev.time||'';document.getElementById('eventLocation').value=ev.location||'';document.getElementById('eventType').value=ev.type||'회의';document.getElementById('urgentAlert').checked=!!ev.urgentAlert;closeEventDetailModal();openEventModal();}
    async function deleteEvent(){if(!currentEventId){alert('삭제할 일정을 찾을 수 없습니다.');return;}if(!confirm('이 일정을 삭제하시겠습니까?'))return;try{await deleteEventDB(currentEventId);await refreshMonthData();updateCalendar();updateUrgentTasks();updateLastModified();closeEventDetailModal();alert('일정이 삭제되었습니다.');}catch(err){alert(err.message||'삭제 중 오류');}}

    /* ===== 메모 ===== */
    function openMemoModal(){document.getElementById('memoModal').classList.remove('hidden');document.getElementById('memoModal').classList.add('flex');}
    function closeMemoModal(){document.getElementById('memoModal').classList.add('hidden');document.getElementById('memoModal').classList.remove('flex');document.getElementById('memoForm').reset();}
    async function addMemo(e){e.preventDefault();const department=document.getElementById('memoDepartment').value;const content=document.getElementById('memoContent').value;const password=document.getElementById('memoPassword').value;try{await insertMemoDB({department,content,password});await refreshMemos();closeMemoModal();updateLastModified();}catch(err){alert(err.message||'메모 추가 중 오류');}}
    function updateMemoList(){const list=document.getElementById('memoList');list.innerHTML=memos.map((m,i)=>`<div class="memo-item bg-white bg-opacity-50 p-3 rounded-lg cursor-pointer hover:bg-opacity-70" onclick="openMemoDetail(${i}); return false;"><div class="font-medium text-green-800 truncate">${m.content.substring(0,30)}${m.content.length>30?'...':''}</div><div class="text-xs text-green-600">${m.date}</div></div>`).join('');}
    function openMemoDetail(i){currentMemoIndex=i;const m=memos[i];document.getElementById('memoDetailContent').innerHTML=`<div class="whitespace-pre-wrap">${m.content}</div><div class="text-xs text-green-600 mt-2">작성일: ${m.date}</div>`;document.getElementById('memoDetailModal').classList.remove('hidden');document.getElementById('memoDetailModal').classList.add('flex');}
    function closeMemoDetailModal(){document.getElementById('memoDetailModal').classList.add('hidden');document.getElementById('memoDetailModal').classList.remove('flex');currentMemoIndex=null;}
    function openPasswordModal(){document.getElementById('passwordModal').classList.remove('hidden');document.getElementById('passwordModal').classList.add('flex');}
    function closePasswordModal(){document.getElementById('passwordModal').classList.add('hidden');document.getElementById('passwordModal').classList.remove('flex');document.getElementById('passwordForm').reset();}
    async function deleteMemo(e){e.preventDefault();const inputPw=document.getElementById('deletePassword').value;const memo=memos[currentMemoIndex];if(!memo){alert('메모를 찾을 수 없습니다.');return;}try{await deleteMemoDB(memo.id,inputPw);closeMemoDetailModal();closePasswordModal();await refreshMemos();updateLastModified();}catch(err){alert(err.message||'비밀번호가 일치하지 않습니다.');}}

    /* ===== 제출 임박 ===== */
    function updateUrgentTasks(){
      const box=document.getElementById('urgentTasks');const today=new Date();today.setHours(0,0,0,0);const list=[];
      Object.keys(events).forEach(k=>{
        const [y,m,d]=k.split('-').map(Number);
        const dt=new Date(y,m,d);dt.setHours(0,0,0,0);
        const diff=Math.ceil((dt-today)/(1000*60*60*24));
        (events[k]||[]).forEach(ev=>{
          if(ev.urgentAlert && diff<=3 && diff>=0){
            list.push({...ev,daysLeft:diff,dateKey:k});
          }
        });
      });
      list.sort((a,b)=>a.daysLeft-b.daysLeft);
      box.innerHTML = list.length===0 ? '<div class="text-green-600 text-center py-4">현재 제출 임박 항목이 없습니다.</div>' :
        list.map(t=>{
          let c='bg-yellow-100 border-yellow-500',tc='text-yellow-800',dc='text-yellow-600';
          if(t.daysLeft===0){c='bg-red-100 border-red-500';tc='text-red-800';dc='text-red-600';}
          else if(t.daysLeft===1){c='bg-orange-100 border-orange-500';tc='text-orange-800';dc='text-orange-600';}
          return `<div class="${c} border-l-4 p-3 rounded cursor-pointer hover:bg-opacity-80" onclick="openEventDetail('${t.dateKey}','${t.id}'); return false;">
                    <p class="${tc} font-medium">${t.title}</p>
                    <p class="${dc} text-sm">마감: ${t.daysLeft===0?'오늘':t.daysLeft+'일 후'}</p>
                    ${t.time?`<p class="${dc} text-xs">시간: ${t.time}</p>`:''}
                    ${t.location?`<p class="${dc} text-xs">장소: ${t.location}</p>`:''}
                  </div>`;
        }).join('');
    }

    /* ===== 이미지 업로드 ===== */
    async function handleImageUpload(e){
      const file=e.target.files[0];const uploaded=document.getElementById('uploadedImages');const btn=document.getElementById('uploadButton');
      if(file&&file.type.startsWith('image/')){
        try{
          const {url}=await uploadImageToStorage(file);
          uploaded.innerHTML=''; btn.classList.add('hidden'); uploaded.classList.remove('hidden');
          const div=document.createElement('div'); div.className='relative group cursor-pointer w-full';
          div.innerHTML=`
            <img src="${url}" class="w-full h-auto rounded-lg shadow-md">
            <div class="absolute inset-0 bg-black bg-opacity-50 rounded-lg opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center gap-2">
              <button onclick="editImage(this); return false;" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">수정</button>
              <button onclick="deleteImage(this); return false;" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">삭제</button>
            </div>`;
          uploaded.appendChild(div);
          updateLastModified();
        }catch(err){alert('업로드 실패: '+(err.message||''));}
      }
      e.target.value='';
    }
    function editImage(button){
      const input=document.createElement('input');
      input.type='file'; input.accept='image/*';
      input.onchange=async e=>{
        const f=e.target.files[0];
        if(!(f&&f.type.startsWith('image/')))return;
        try{
          const {url}=await uploadImageToStorage(f);
          const group=button.closest('.group'); group.querySelector('img').src=url;
          updateLastModified();
        }catch(err){alert('업로드 실패');}
      };
      input.click();
    }
    function deleteImage(){
      const uploaded=document.getElementById('uploadedImages');const btn=document.getElementById('uploadButton');
      uploaded.innerHTML=''; uploaded.classList.add('hidden'); btn.classList.remove('hidden'); updateLastModified();
    }
    function updateLastModified(){document.getElementById('lastModified').textContent=new Date().toLocaleString('ko-KR');}

    /* ===== inline onclick에서 찾을 수 있도록 전역 노출 ===== */
    window.openEventDetail = openEventDetail;
    window.openMemoDetail = openMemoDetail;
    window.editImage = editImage;
    window.deleteImage = deleteImage;
  </script>
</body>
</html>
