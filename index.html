<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ëŒ€ì „ì¥ëŒ€ì¤‘í•™êµ ì—…ë¬´ ì•ˆë‚´</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body{background:linear-gradient(135deg,#f0fdf4 0%,#dcfce7 50%,#bbf7d0 100%);font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    .glass-effect{background:rgba(255,255,255,.85);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.9);box-shadow:0 8px 32px rgba(0,0,0,.1)}
    .modal-glass{background:rgba(255,255,255,.95);backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,.8)}
    .calendar-day{min-height:72px;transition:all .3s ease}
    .calendar-day:hover{background:rgba(255,255,255,.3)}
    .week-day{min-height:110px}
    .memo-item{transition:transform .2s ease}
    .memo-item:hover{transform:translateY(-2px)}
    @media (max-width: 640px){
      .calendar-day{min-height:56px;padding:6px}
      .week-day{min-height:90px;padding:10px}
      .calendar-day .text-xs,.week-day .text-xs{font-size:.7rem}
      /* ëª¨ë°”ì¼ì—ì„œ ì¼ì • ì¹© 2ì¤„ í—ˆìš© */
      .truncate{white-space:normal;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    }
  </style>

  <script>
    /* --- Supabase ì´ˆê¸°í™” (ë„¤ í”„ë¡œì íŠ¸ ê°’) --- */
    const SUPABASE_URL = "https://crwpivblcgvnhmtphlhm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNyd3BpdmJsY2d2bmhtdHBobGhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxODIxNjQsImV4cCI6MjA3NDc1ODE2NH0.7O8-w4NFKBlo0h9uESWt5sCGd-XWoRnsf_Pu3cpkcZc";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {auth:{persistSession:true,autoRefreshToken:true}});

    /* 4ìë¦¬ ë¹„ë²ˆ í•´ì‹œ */
    async function sha256(text){const enc=new TextEncoder().encode(text);const buf=await crypto.subtle.digest('SHA-256',enc);return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');}
  </script>
</head>

<body class="min-h-screen p-3 sm:p-4">
  <div class="max-w-7xl mx-auto">
    <!-- í—¤ë” -->
    <div class="glass-effect rounded-2xl p-6 mb-6 shadow-lg">
      <div class="flex flex-col gap-4 sm:flex-row sm:justify-between sm:items-center">
        <div class="flex items-center gap-4">
          <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center shadow-lg">
            <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6l2-1.09V17h2V9L12 3zm6.82 6L12 12.72 5.18 9 12 5.28 18.82 9zM17 15.99l-5 2.73-5-2.73v-3.72L12 15l5-2.73v3.72z"/>
            </svg>
          </div>
          <h1 class="text-2xl sm:text-3xl font-bold text-green-800">ëŒ€ì „ì¥ëŒ€ì¤‘í•™êµ ì›”ê°„/ì£¼ê°„ ì—…ë¬´ ê³„íš</h1>
        </div>
        <!-- ë²„íŠ¼: ëª¨ë°”ì¼ ì„¸ë¡œ, smë¶€í„° ê°€ë¡œ -->
        <div class="flex gap-2 flex-col sm:flex-row">
          <button id="monthViewBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">ì›”ê°„ ë³´ê¸°</button>
          <button id="weekViewBtn" class="px-6 py-2 bg-white text-green-600 rounded-lg hover:bg-green-50 transition-colors font-medium border border-green-600">ì£¼ê°„ ë³´ê¸°</button>
        </div>
      </div>
    </div>

    <!-- ì œì¶œì„ë°• & í€µë©”ëª¨ì¡´ -->
    <div class="grid md:grid-cols-2 gap-6 mb-6">
      <div class="glass-effect rounded-2xl p-6 shadow-lg">
        <h2 class="text-xl font-bold text-green-800 mb-4 flex items-center"><span class="mr-2">âš ï¸</span>ì œì¶œì„ë°•</h2>
        <div id="urgentTasks" class="space-y-3"></div>
      </div>

      <div class="glass-effect rounded-2xl p-6 shadow-lg">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-green-800 flex items-center"><span class="mr-2">ğŸ“</span>í€µ ë©”ëª¨ì¡´</h2>
          <button id="addMemoBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">ë©”ëª¨ ì¶”ê°€</button>
        </div>
        <div id="memoList" class="space-y-2 max-h-40 overflow-y-auto"></div>
      </div>
    </div>

    <!-- ì›”ë³„/ì£¼ë³„ ì¼ì • -->
    <div class="glass-effect rounded-2xl p-6 mb-6 shadow-lg">
      <div id="calendarHeader" class="flex justify-between items-center mb-6">
        <button id="prevBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">â—€ ì´ì „</button>
        <h2 id="calendarTitle" class="text-2xl font-bold text-green-800">2025ë…„ 1ì›”</h2>
        <button id="nextBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">ë‹¤ìŒ â–¶</button>
      </div>

      <!-- ì›”ê°„: ê°€ë¡œ ìŠ¤í¬ë¡¤ ë˜í¼ -->
      <div id="monthView" class="calendar-view">
        <div class="overflow-x-auto -mx-2 px-2">
          <div class="grid min-w-[700px] grid-cols-7 gap-1 mb-2">
            <div class="text-center font-bold text-red-600 p-2">ì¼</div>
            <div class="text-center font-bold text-green-800 p-2">ì›”</div>
            <div class="text-center font-bold text-green-800 p-2">í™”</div>
            <div class="text-center font-bold text-green-800 p-2">ìˆ˜</div>
            <div class="text-center font-bold text-green-800 p-2">ëª©</div>
            <div class="text-center font-bold text-green-800 p-2">ê¸ˆ</div>
            <div class="text-center font-bold text-blue-600 p-2">í† </div>
          </div>
        </div>
        <div class="overflow-x-auto -mx-2 px-2">
          <div id="monthCalendar" class="grid min-w-[700px] grid-cols-7 gap-1"></div>
        </div>
      </div>

      <!-- ì£¼ê°„: 1â†’2â†’7ì—´ ë°˜ì‘í˜• -->
      <div id="weekView" class="calendar-view hidden">
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-7 gap-2">
          <div class="text-center font-bold text-red-600 p-2">ì¼</div>
          <div class="text-center font-bold text-green-800 p-2">ì›”</div>
          <div class="text-center font-bold text-green-800 p-2">í™”</div>
          <div class="text-center font-bold text-green-800 p-2">ìˆ˜</div>
          <div class="text-center font-bold text-green-800 p-2">ëª©</div>
          <div class="text-center font-bold text-green-800 p-2">ê¸ˆ</div>
          <div class="text-center font-bold text-blue-600 p-2">í† </div>
        </div>
        <div id="weekCalendar" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-7 gap-2 mt-2"></div>
      </div>

      <button id="addEventBtn" class="mt-6 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium w-full">ì¼ì • ì¶”ê°€</button>
    </div>

    <!-- ìë£Œ ì§‘ê³„ -->
    <div class="glass-effect rounded-2xl p-6 shadow-lg">
      <h2 class="text-xl font-bold text-green-800 mb-4 flex items-center"><span class="mr-2">ğŸ“Š</span>ìë£Œ ì§‘ê³„</h2>
      <div id="uploadArea" class="border-2 border-dashed border-green-400 rounded-lg text-center mb-4">
        <input type="file" id="imageUpload" accept="image/*" class="hidden">
        <div id="uploadButton" class="p-8">
          <button onclick="document.getElementById('imageUpload').click()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">ğŸ“· ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
          <p class="text-green-700 mt-2">í™”ë©´ ìº¡ì³ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
        </div>
        <div id="uploadedImages" class="p-4 hidden w-full"></div>
        <div class="text-right text-green-700 text-sm mt-4 px-4 pb-4">
          ìµœì¢… ìˆ˜ì •: <span id="lastModified">-</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ì¼ì •/ë©”ëª¨/ë¹„ë²ˆ/ìƒì„¸ ëª¨ë‹¬ë“¤ (í­: ëª¨ë°”ì¼ ì•ˆì „í­) -->
  <div id="eventModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="modal-glass rounded-2xl p-6 max-w-md w-[95vw] mx-4 max-h-[90vh] overflow-y-auto shadow-2xl">
      <h3 class="text-xl font-bold text-green-800 mb-4">ì¼ì • ì¶”ê°€</h3>
      <form id="eventForm">
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">ë¶€ì„œ</label>
          <select id="eventDepartment" class="w-full p-3 border border-green-300 rounded-lg" required>
            <option value="">ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
            <option>êµë¬´ìš´ì˜ë¶€</option><option>êµìœ¡ì—°êµ¬ë¶€</option><option>ìƒí™œì•ˆì „ë¶€</option>
            <option>êµìœ¡ì •ë³´íƒêµ¬ë¶€</option><option>ì²´ìœ¡ë³´ê±´ë¶€</option><option>ì§„ë¡œì§„í•™ìƒë‹´ë¶€</option>
            <option>ì§€ì—­ì‚¬íšŒí™˜ê²½ë¶€</option><option>í•™ë ¥ì‹ ì¥ë°©ê³¼í›„í•™êµë¶€</option>
            <option>1í•™ë…„ë¶€</option><option>2í•™ë…„ë¶€</option><option>3í•™ë…„ë¶€</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">ì œëª©</label>
          <input type="text" id="eventTitle" class="w-full p-3 border border-green-300 rounded-lg" required>
        </div>
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">ì„¤ëª…</label>
          <textarea id="eventDescription" class="w-full p-3 border border-green-300 rounded-lg h-20"></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">ì‹œê°„</label>
          <input type="time" id="eventTime" class="w-full p-3 border border-green-300 rounded-lg">
        </div>
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">ì¥ì†Œ</label>
          <input type="text" id="eventLocation" class="w-full p-3 border border-green-300 rounded-lg">
        </div>
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">ìœ í˜•</label>
          <select id="eventType" class="w-full p-3 border border-green-300 rounded-lg">
            <option>íšŒì˜</option><option>ì œì¶œ</option><option>í•™ì‚¬ì¼ì •</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="flex items-center">
            <input type="checkbox" id="urgentAlert" class="mr-2">
            <span class="text-green-800">ì œì¶œ ì„ë°• ì•ŒëŒ í‘œì‹œ</span>
          </label>
        </div>
        <div class="flex gap-3">
          <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">ì¶”ê°€</button>
          <button type="button" id="cancelEventBtn" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">ì·¨ì†Œ</button>
        </div>
      </form>
    </div>
  </div>

  <div id="memoModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="modal-glass rounded-2xl p-6 max-w-md w-[95vw] mx-4 shadow-2xl">
      <h3 class="text-xl font-bold text-green-800 mb-4">ë©”ëª¨ ì¶”ê°€</h3>
      <form id="memoForm">
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">ë¶€ì„œ</label>
          <select id="memoDepartment" class="w-full p-3 border border-green-300 rounded-lg" required>
            <option value="">ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
            <option>êµë¬´ìš´ì˜ë¶€</option><option>êµìœ¡ì—°êµ¬ë¶€</option><option>ìƒí™œì•ˆì „ë¶€</option>
            <option>êµìœ¡ì •ë³´íƒêµ¬ë¶€</option><option>ì²´ìœ¡ë³´ê±´ë¶€</option><option>ì§„ë¡œì§„í•™ìƒë‹´ë¶€</option>
            <option>ì§€ì—­ì‚¬íšŒí™˜ê²½ë¶€</option><option>í•™ë ¥ì‹ ì¥ë°©ê³¼í›„í•™êµë¶€</option>
            <option>1í•™ë…„ë¶€</option><option>2í•™ë…„ë¶€</option><option>3í•™ë…„ë¶€</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">ë©”ëª¨ ë‚´ìš©</label>
          <textarea id="memoContent" class="w-full p-3 border border-green-300 rounded-lg h-24" required></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬ ìˆ«ì)</label>
          <input type="password" id="memoPassword" class="w-full p-3 border border-green-300 rounded-lg" pattern="[0-9]{4}" maxlength="4" required>
        </div>
        <div class="flex gap-3">
          <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">ì¶”ê°€</button>
          <button type="button" id="cancelMemoBtn" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">ì·¨ì†Œ</button>
        </div>
      </form>
    </div>
  </div>

  <div id="memoDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="modal-glass rounded-2xl p-6 max-w-md w-[95vw] mx-4 shadow-2xl">
      <h3 class="text-xl font-bold text-green-800 mb-4">ë©”ëª¨ ìƒì„¸</h3>
      <div id="memoDetailContent" class="mb-4 p-3 bg-white bg-opacity-50 rounded-lg min-h-[100px]"></div>
      <div class="flex gap-3">
        <button id="deleteMemoBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">ì‚­ì œ</button>
        <button id="closeMemoDetailBtn" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <div id="eventDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="modal-glass rounded-2xl p-6 max-w-md w-[95vw] mx-4 max-h-[90vh] overflow-y-auto shadow-2xl">
      <h3 class="text-xl font-bold text-green-800 mb-4">ì¼ì • ìƒì„¸</h3>
      <div id="eventDetailContent" class="mb-4 space-y-3"></div>
      <div class="flex gap-3">
        <button id="editEventBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">í¸ì§‘</button>
        <button id="deleteEventBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">ì‚­ì œ</button>
        <button id="closeEventDetailBtn" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="modal-glass rounded-2xl p-6 max-w-sm w-[95vw] mx-4 shadow-2xl">
      <h3 class="text-xl font-bold text-green-800 mb-4">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</h3>
      <form id="passwordForm">
        <div class="mb-4">
          <label class="block text-green-800 font-medium mb-2">ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</label>
          <input type="password" id="deletePassword" class="w-full p-3 border border-green-300 rounded-lg" pattern="[0-9]{4}" maxlength="4" required>
        </div>
        <div class="flex gap-3">
          <button type="submit" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">ì‚­ì œ</button>
          <button type="button" id="cancelPasswordBtn" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">ì·¨ì†Œ</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    /* ===== ìƒíƒœ ===== */
    let currentDate=new Date(), currentView='month', selectedDate=null;
    let events={}, memos=[], currentMemoIndex=null, currentEventId=null, isEditingEvent=false;

    const holidays={'2025':{'0-1':'ì‹ ì •','0-27':'ì„¤ë‚  ì—°íœ´','0-28':'ì„¤ë‚ ','0-29':'ì„¤ë‚  ì—°íœ´','2-1':'ì‚¼ì¼ì ˆ','2-3':'ì‚¼ì¼ì ˆ ëŒ€ì²´ê³µíœ´ì¼','4-5':'ì–´ë¦°ì´ë‚ ','4-6':'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ','5-6':'í˜„ì¶©ì¼','7-15':'ê´‘ë³µì ˆ','9-5':'ì¶”ì„ ì—°íœ´','9-6':'ì¶”ì„','9-7':'ì¶”ì„ ì—°íœ´','9-8':'ì¶”ì„ ëŒ€ì²´ê³µíœ´ì¼','9-3':'ê°œì²œì ˆ','9-9':'í•œê¸€ë‚ ','11-25':'ì„±íƒ„ì ˆ'}};
    function checkHoliday(date){const y=date.getFullYear().toString(),m=date.getMonth(),d=date.getDate(),k=`${m}-${d}`;return holidays[y]&&holidays[y][k];}

    /* ===== Supabase CRUD ===== */
    async function fetchEventsForMonth(year,month){
      const start=new Date(year,month,1).toISOString().slice(0,10);
      const end=new Date(year,month+1,0).toISOString().slice(0,10);
      const {data,error}=await supabase.from('events').select('*').gte('event_date',start).lte('event_date',end).order('event_date',{ascending:true});
      if(error){console.error(error);return {};}
      const grouped={}; (data||[]).forEach(ev=>{const d=new Date(ev.event_date);const k=`${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;if(!grouped[k])grouped[k]=[];grouped[k].push({id:ev.id,department:ev.department,title:`[${ev.department}] ${ev.title}`,description:ev.description,time:ev.time,location:ev.location,type:ev.type,urgentAlert:!!ev.urgent_alert});});
      return grouped;
    }
    async function insertEventDB(p){const {data,error}=await supabase.from('events').insert({event_date:p.eventDate,department:p.department,title:p.title,description:p.description||null,time:p.time||null,location:p.location||null,type:p.type||'íšŒì˜',urgent_alert:!!p.urgentAlert}).select().single();if(error)throw error;return data;}
    async function updateEventDB(id,p){const {data,error}=await supabase.from('events').update({department:p.department,title:p.title
